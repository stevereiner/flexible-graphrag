<mat-card class="mb-4">
  <mat-card-header>
    <mat-card-title>Ingest Documents</mat-card-title>
    <mat-card-subtitle>Ingest documents from various data sources</mat-card-subtitle>
  </mat-card-header>
  
  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Data Source Selection -->
      <mat-form-field appearance="outline" class="w-100 mb-3">
        <mat-label>Data Source</mat-label>
        <mat-select formControlName="dataSource" [disabled]="isProcessing">
          <mat-option value="filesystem">File System</mat-option>
          <mat-option value="cmis">CMIS Repository</mat-option>
          <mat-option value="alfresco">Alfresco Repository</mat-option>
        </mat-select>
        <mat-hint>Choose the data source for document ingestion</mat-hint>
      </mat-form-field>

      <!-- File System Path Input -->
      <mat-form-field appearance="outline" class="w-100" *ngIf="form.value.dataSource === 'filesystem'">
        <mat-label>File or Folder Path</mat-label>
        <input 
          matInput 
          formControlName="folderPath"
          placeholder="Enter file or folder path"
          [disabled]="isProcessing"
        >
        <mat-hint>Enter the path to a file or folder you want to process</mat-hint>
      </mat-form-field>

      <!-- CMIS Configuration -->
      <div *ngIf="form.value.dataSource === 'cmis'" class="cmis-config">
        <mat-form-field appearance="outline" class="w-100 mb-2">
          <mat-label>CMIS Repository URL</mat-label>
          <input 
            matInput 
            formControlName="cmisUrl"
            [placeholder]="environment.cmisBaseUrl + '/alfresco/api/-default-/public/cmis/versions/1.1/atom'"
            [disabled]="isProcessing"
          >
        </mat-form-field>
        
        <div class="row">
          <div class="col-md-6">
            <mat-form-field appearance="outline" class="w-100 mb-2">
              <mat-label>Username</mat-label>
              <input 
                matInput 
                formControlName="cmisUsername"
                placeholder="Enter CMIS username"
                [disabled]="isProcessing"
              >
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field appearance="outline" class="w-100 mb-2">
              <mat-label>Password</mat-label>
              <input 
                matInput 
                type="password"
                formControlName="cmisPassword"
                placeholder="Enter CMIS password"
                [disabled]="isProcessing"
              >
            </mat-form-field>
          </div>
        </div>
        
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Folder Path</mat-label>
          <input 
            matInput 
            formControlName="folderPath"
            placeholder="/Sites/example-site/documentLibrary"
            [disabled]="isProcessing"
          >
          <mat-hint>CMIS folder path to process</mat-hint>
        </mat-form-field>
      </div>

      <!-- Alfresco Configuration -->
      <div *ngIf="form.value.dataSource === 'alfresco'" class="alfresco-config">
        <mat-form-field appearance="outline" class="w-100 mb-2">
          <mat-label>Alfresco Base URL</mat-label>
          <input 
            matInput 
            formControlName="alfrescoUrl"
            [placeholder]="environment.alfrescoBaseUrl + '/alfresco'"
            [disabled]="isProcessing"
          >
        </mat-form-field>
        
        <div class="row">
          <div class="col-md-6">
            <mat-form-field appearance="outline" class="w-100 mb-2">
              <mat-label>Username</mat-label>
              <input 
                matInput 
                formControlName="alfrescoUsername"
                placeholder="Enter Alfresco username"
                [disabled]="isProcessing"
              >
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field appearance="outline" class="w-100 mb-2">
              <mat-label>Password</mat-label>
              <input 
                matInput 
                type="password"
                formControlName="alfrescoPassword"
                placeholder="Enter Alfresco password"
                [disabled]="isProcessing"
              >
            </mat-form-field>
          </div>
        </div>
        
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Path</mat-label>
          <input 
            matInput 
            formControlName="folderPath"
            placeholder="/Sites/example-site/documentLibrary"
            [disabled]="isProcessing"
          >
          <mat-hint>Alfresco path to process</mat-hint>
        </mat-form-field>
      </div>

      <!-- Processing Status -->
      <div *ngIf="isProcessing" class="processing-status mt-3 mb-3">
        <div class="d-flex align-items-center mb-2">
          <mat-spinner diameter="20" class="me-2"></mat-spinner>
          <span class="status-text">{{ processingStatus || 'Processing documents...' }}</span>
        </div>
        <mat-progress-bar 
          mode="determinate" 
          [value]="processingProgress"
          class="progress-bar"
        ></mat-progress-bar>
        <small class="progress-text">
          {{ processingProgress }}% complete
          <div *ngIf="statusData?.file_progress" class="mt-1">
            {{ statusData.file_progress }}
          </div>
          <div *ngIf="statusData?.current_file" class="mt-1">
            Processing: {{ getFileName(statusData.current_file) }}
          </div>
          <div *ngIf="statusData?.current_phase" class="mt-1">
            Phase: {{ statusData.current_phase }}
          </div>
          <div *ngIf="statusData?.estimated_time_remaining" class="mt-1">
            Time remaining: {{ statusData.estimated_time_remaining }}
          </div>
        </small>
        <button 
          type="button"
          mat-stroked-button 
          color="warn" 
          (click)="cancelProcessing()"
          class="cancel-btn mt-2"
          [disabled]="!currentProcessingId"
        >
          Cancel Processing
        </button>
      </div>

      <!-- Success Message -->
      <div *ngIf="successMessage" class="alert alert-success alert-dismissible mt-3">
        {{ successMessage }}
        <button type="button" class="btn-close" aria-label="Close" (click)="successMessage = ''"></button>
      </div>

      <!-- Error Message -->
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible mt-3">
        {{ errorMessage }}
        <button type="button" class="btn-close" aria-label="Close" (click)="errorMessage = ''"></button>
      </div>

      <div class="mt-3">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          [disabled]="form.invalid || isProcessing"
        >
          <span *ngIf="!isProcessing">Ingest Documents</span>
          <span *ngIf="isProcessing">Processing...</span>
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
