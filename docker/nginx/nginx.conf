events {
    worker_connections 1024;
}

http {
    upstream backend {
        server flexible-graphrag-backend:8000;
    }
    
    upstream angular {
        server flexible-graphrag-angular:4200;
    }
    
    upstream react {
        server flexible-graphrag-react:3000;
    }
    
    upstream vue {
        server flexible-graphrag-vue:5173;
    }

    server {
        listen 80;
        server_name localhost _;
        
        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # API proxy - main routes
        location /api/ {
            proxy_pass http://backend/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
        }
        
        # API proxy for React UI (base path /ui/react/)
        location /ui/react/api/ {
            rewrite ^/ui/react/api/(.*) /api/$1 break;
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
        }

        # Database admin interfaces
        # Neo4j interface (commented out - using external Neo4j)
        # location /neo4j/ {
        #     proxy_pass http://flexible-graphrag-neo4j:7474/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        # }
        
        # Kuzu explorer (commented out - container not running)
        # location /kuzu-explorer/ {
        #     proxy_pass http://flexible-graphrag-kuzu-explorer:8000/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        # }
        
        #location /qdrant/ {
        #    proxy_pass http://flexible-graphrag-qdrant:6333/;
        #    proxy_set_header Host $host;
        #    proxy_set_header X-Real-IP $remote_addr;
        #}
        
        # Elasticsearch interface (commented out temporarily)
        # location /elasticsearch/ {
        #     proxy_pass http://flexible-graphrag-elasticsearch:9200/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        # }
        
        # OpenSearch routes (commented out temporarily)
        # location /opensearch/ {
        #     proxy_pass http://flexible-graphrag-opensearch:9200/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        # }
        
        # location /opensearch-dashboards/ {
        #     proxy_pass http://flexible-graphrag-opensearch-dashboards:5601/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        # }

        # Alfresco routes (commented out - not needed for current setup)
        # location /alfresco/ {
        #     proxy_pass http://flexible-graphrag-alfresco:8080/alfresco/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        # }
        
        # location /share/ {
        #     proxy_pass http://flexible-graphrag-alfresco-share:8080/share/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        # }

        # UI proxies with comprehensive asset routing
        # Angular UI (serves at root, strip /ui/angular prefix)
        location /ui/angular/ {
            rewrite ^/ui/angular/(.*) /$1 break;
            proxy_pass http://angular/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_cache_bypass $http_upgrade;
        }
        
        # React UI (serves at /ui/react/ with base path)
        location /ui/react/ {
            proxy_pass http://react/ui/react/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_cache_bypass $http_upgrade;
        }
        
        # Vue UI (serves at /ui/vue/ with base path)
        location /ui/vue/ {
            proxy_pass http://vue/ui/vue/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_cache_bypass $http_upgrade;
        }

        # Root endpoint - no auto-redirect
        location = / {
            return 200 "Flexible GraphRAG - Choose your UI:\n- Angular: /ui/angular/\n- React: /ui/react/\n- Vue: /ui/vue/\n- API: /api/\n";
            add_header Content-Type text/plain;
        }
        
        # Exact UI paths without trailing slash - redirect to add slash
        location = /ui/angular {
            return 302 $scheme://$host:$server_port/ui/angular/;
        }
        location = /ui/react {
            return 302 $scheme://$host:$server_port/ui/react/;
        }
        location = /ui/vue {
            return 302 $scheme://$host:$server_port/ui/vue/;
        }
        
        # Fallback for direct UI access
        location /ui/ {
            return 302 $scheme://$host:$server_port/ui/react/;
        }
    }
}
